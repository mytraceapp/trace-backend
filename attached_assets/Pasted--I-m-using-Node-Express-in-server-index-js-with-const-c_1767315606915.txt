
I’m using Node + Express in server/index.js with:
const { createClient } = require('@supabase/supabase-js');
const supabaseUrl = process.env.SUPABASE_URL || process.env.VITE_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
const supabaseServer = createClient(supabaseUrl, supabaseServiceKey);

The mobile app sends the current user’s Supabase access token in the Authorization: Bearer <token> header for authenticated requests.

I need a new endpoint to let a logged-in user delete their account and all related data.

Please:
	1.	Add a small helper to extract and verify the user:

async function getUserFromAuthHeader(req) {
  const authHeader = req.headers.authorization || '';
  const token = authHeader.startsWith('Bearer ') ? authHeader.slice(7) : null;
  if (!token) {
    return { user: null, error: 'Missing bearer token' };
  }

  const { data, error } = await supabaseServer.auth.getUser(token);
  if (error || !data?.user) {
    return { user: null, error: 'Invalid or expired token' };
  }

  return { user: data.user, error: null };
}

	2.	Create a new route:

app.delete('/api/account', async (req, res) => {
  try {
    const { user, error: authError } = await getUserFromAuthHeader(req);
    if (authError || !user) {
      return res.status(401).json({ error: 'Unauthorized' });
    }

    const userId = user.id;

    // 1) Delete per-user data from our tables
    // Replace table names/columns if needed:
    const deletePromises = [
      supabaseServer.from('entries').delete().eq('user_id', userId),
      supabaseServer.from('activities').delete().eq('user_id', userId),
      supabaseServer.from('profiles').delete().eq('user_id', userId),
      // add any other user-scoped tables here
    ];

    const results = await Promise.all(deletePromises);
    const tableError = results.find(r => r.error)?.error;
    if (tableError) {
      console.error('[DeleteAccount] table delete error', tableError);
      return res.status(500).json({ error: 'Failed to delete user data' });
    }

    // 2) Delete the auth user using the service role client
    const { error: deleteUserError } = await supabaseServer.auth.admin.deleteUser(userId);
    if (deleteUserError) {
      console.error('[DeleteAccount] auth delete error', deleteUserError);
      return res.status(500).json({ error: 'Failed to delete auth user' });
    }

    return res.json({ success: true });
  } catch (err) {
    console.error('[DeleteAccount] unexpected error', err);
    return res.status(500).json({ error: 'Unexpected server error' });
  }
});
3.	Make sure CORS / auth middleware (if any) allows this endpoint and that it’s only callable by authenticated users.

I’ll call this from the app with DELETE /api/account and an Authorization: Bearer <accessToken> header.

Please add the code in the correct place in server/index.js and keep logging minimal but useful.