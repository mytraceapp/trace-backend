I’ll assume:
	•	You already have const app = express();
	•	You already have supabase and openai clients set up.

2.1 Helper: load profile basics

Add near the top:

const { supabase } = require('./supabaseClient');
const { openai } = require('./openaiClient'); // adjust to your file names

async function loadProfileBasic(userId) {
  const { data, error } = await supabase
    .from('profiles') // change if your table is named differently
    .select('id, preferred_name, first_run_completed, first_run_completed_at')
    .eq('id', userId)
    .single();

  if (error) {
    console.error('loadProfileBasic error', error);
    return null;
  }
  return data;
}

2.2 /api/bootstrap – check if first run

This endpoint tells the app:
	•	is this a first-time user?
	•	what’s their displayName, if any?

app.post('/api/bootstrap', async (req, res) => {
  try {
    const { userId } = req.body;
    if (!userId) {
      return res.status(400).json({ error: 'userId required' });
    }

    const profile = await loadProfileBasic(userId);
    if (!profile) {
      return res.status(404).json({ error: 'Profile not found' });
    }

    const displayName = profile.preferred_name?.trim() || null;

    res.json({
      firstRun: !profile.first_run_completed,
      displayName,
    });
  } catch (err) {
    console.error('/api/bootstrap error', err);
    res.status(500).json({ error: 'Bootstrap failed' });
  }
});

First-run greeting prompt builder

Add:

function buildFirstRunGreetingSystemPrompt({ displayName }) {
  const nameLine = displayName
    ? `The user prefers to be called "${displayName}". You may gently use this name once, but do not overuse it or talk about "remembering" it.`
    : `The user has not given a name. Do NOT invent one. Do not call them "friend" as if it were a saved name.`;

  return `
You are TRACE, a calm, gentle emotional companion.

This is the user's FIRST time here.

Your job is to welcome them into a quiet, pressure-free space.

Core feeling:
- This is the one place on their phone that doesn't want anything from them.
- They don't need fixing, productivity, or performance.
- They can simply exist here.

${nameLine}

Write a greeting that:
- is 1–3 short sentences
- communicates "you are welcome exactly as you are"
- mentions that they can just breathe for a moment, or talk if they'd like
- makes it clear there are no streaks, goals, or expectations
- feels warm and unhurried

Do NOT:
- use emojis
- mention that you are an AI or "language model"
- ask lots of questions
- give advice
- say "you told me your name is X" or similar.

After the greeting, subtly invite two options in natural language:
- they can breathe with you
- they can talk about whatever is on their mind

But keep it simple and soft.
  `.trim();
}

2.4 /api/first-greeting – uses that prompt
app.post('/api/first-greeting', async (req, res) => {
  try {
    const { userId } = req.body;
    if (!userId) {
      return res.status(400).json({ error: 'userId required' });
    }

    const profile = await loadProfileBasic(userId);
    if (!profile) {
      return res.status(404).json({ error: 'Profile not found' });
    }

    const displayName = profile.preferred_name?.trim() || null;

    const systemPrompt = buildFirstRunGreetingSystemPrompt({ displayName });

    const messages = [
      { role: 'system', content: systemPrompt },
      {
        role: 'user',
        content:
          'Generate the greeting now. Remember: calm, low-pressure, 1–3 sentences, no emojis.',
      },
    ];

    const completion = await openai.chat.completions.create({
      model: 'gpt-4.1-mini', // or higher if you want max vibe
      messages,
      temperature: 0.7,
    });

    const greeting = completion.choices?.[0]?.message?.content ?? '';

    res.json({ greeting });
  } catch (err) {
    console.error('/api/first-greeting error', err);
    res.status(500).json({ error: 'First greeting failed' });
  }
});

 /api/complete-first-run – flip the flag

We call this once the user either:
	•	finishes breathing flow, or
	•	chooses to talk.
app.post('/api/complete-first-run', async (req, res) => {
  try {
    const { userId } = req.body;
    if (!userId) {
      return res.status(400).json({ error: 'userId required' });
    }

    const { error } = await supabase
      .from('profiles')
      .update({
        first_run_completed: true,
        first_run_completed_at: new Date().toISOString(),
      })
      .eq('id', userId);

    if (error) {
      console.error('/api/complete-first-run update error', error);
      return res.status(500).json({ error: 'Update failed' });
    }

    res.json({ ok: true });
  } catch (err) {
    console.error('/api/complete-first-run error', err);
    res.status(500).json({ error: 'Complete first run failed' });
  }
});