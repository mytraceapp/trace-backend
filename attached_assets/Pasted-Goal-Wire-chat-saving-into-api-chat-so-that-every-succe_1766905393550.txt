Goal:
Wire chat saving into /api/chat so that every successful conversation
stores both the latest user message and TRACE reply into the existing
`messages` table, and log clearly when it happens.

File:
server/index.js   (the one used by `cd Beta-vsafe1zip && node server/index.js`)

Steps:

1. Find the /api/chat endpoint:

   app.post('/api/chat', async (req, res) => {

2. Inside that handler, update the destructuring at the top of the function
   so it includes userId:

   Replace the current line that looks like:

   const { messages: rawMessages, userName, chatStyle = 'conversation', localTime, localDay, localDate } = req.body;

   with:

   const {
     messages: rawMessages,
     userName,
     chatStyle = 'conversation',
     localTime,
     localDay,
     localDate,
     userId,
   } = req.body;

3. Immediately AFTER that destructuring, add this:

   // Use real userId if provided, otherwise use a fixed debug UUID
   const effectiveUserId =
     userId || '00000000-0000-0000-0000-000000000001';

   console.log('[TRACE CHAT] effectiveUserId:', effectiveUserId);

4. Find where the server has already normalized / filtered the messages array
   (usually a `const messages = ...` built from `rawMessages`).

   RIGHT AFTER the messages array is ready (and BEFORE calling OpenAI),
   insert this block:

   // Save latest user message safely (non-blocking for the chat)
   try {
     if (effectiveUserId && Array.isArray(messages)) {
       const lastUserMsg = messages.filter(m => m.role === 'user').pop();
       if (lastUserMsg?.content) {
         await saveUserMessage(effectiveUserId, lastUserMsg.content);
       }
     }
   } catch (err) {
     console.error('[TRACE CHAT SAVE USER ERROR]', err.message || err);
   }

5. Scroll down in the same /api/chat handler until you see where the reply
   is sent, something like:

   res.json({
     message: parsed.message,
     activity_suggestion: ...
   });

   Just ABOVE that res.json, insert:

   // Save assistant reply safely
   try {
     if (effectiveUserId && parsed?.message) {
       await saveAssistantMessage(effectiveUserId, parsed.message);
     }
   } catch (err) {
     console.error('[TRACE CHAT SAVE ASSISTANT ERROR]', err.message || err);
   }

6. Do NOT change anything else in /api/chat.
   Do NOT change the response format.
   Just add the effectiveUserId + the two save blocks.

After applying:
- Restart the backend: `cd Beta-vsafe1zip && node server/index.js`
- Send ONE message from the TRACE chat on your phone.
- In Replit console you should see:
  - `[TRACE CHAT] effectiveUserId: ...`
  - `[TRACE SAVE USER OK] ...`
  - `[TRACE SAVE ASSISTANT OK] ...`

Then open Supabase → `public.messages` and refresh —  
you should see a brand new row at the top.