You are working in the TRACE backend repo (Node/Express). Implement Premium Conversation Engine v1 focused on:

Intuition (#2), Memory (#3), Premium Moments (#4), Breathing (#5), Guided Next Step prompts (#7)
PLUS: strict Everyday Voice enforcement + repetition elimination + dream-door gating.

Dream Door is NOT an activity. Dream Door is a conversational experience triggered naturally when the user mentions dreams. Never output activity_suggestion for dream moments.

â¸»

0) NON-NEGOTIABLE GOALS
	1.	TRACE must sound everyday + human, not therapist.
	2.	TRACE must feel intuitive (asks the right next question, not filler).
	3.	Default responses must be short + breathable.
	4.	Premium Moments should be rare + earned (cooldown + time-window rules).
	5.	Guided steps are conversation prompts only (NOT activities, no navigation).
	6.	Fix repetition: no repeated openers/content back-to-back or within a short window.
	7.	All state must be bounded (caps + cleanup enforced in code).

â¸»

1) DEFINITIONS (CRITICAL)

1.1 Turn counting (used everywhere)

turnCount = number of USER messages in the current conversation session.
	â€¢	Does NOT include assistant messages.
	â€¢	Resets on new session start (see session logic below).

1.2 Session definition

A â€œsessionâ€ is continuous conversation with no > 6 hour gap since last user activity.
	â€¢	If user returns after 6+ hours, start a new session and reset session-turn counters + per-session gates.

Store:
	â€¢	sessionStartedAt
	â€¢	lastUserAt
	â€¢	sessionTurnCount (user-only)

â¸»

2) CONTEXT HIERARCHY (WHAT WINS)

Only ONE layer controls final output:
	1.	CRISIS response (overrides everything)
	2.	PREMIUM MOMENT response (if fired â†’ this is the response; suppress guided step)
	3.	REGULAR response = everyday voice + (optional insight) + Next Best Question (max 1 question)
	4.	GUIDED NEXT STEP (only if pause detected AND no premium AND not crisis)

Implement hierarchy centrally so systems cannot compete.

â¸»

3) EVERYDAY VOICE ENFORCEMENT (SYSTEM RULES + SANITIZER)

3.1 System prompt: Everyday TRACE Voice Canon
	â€¢	Text like a real human. Short, direct, natural.
	â€¢	Avoid therapist language / â€œclinical vibe.â€
	â€¢	Avoid phrases like:
â€œit sounds likeâ€, â€œthat must be hardâ€, â€œI hear youâ€, â€œhold spaceâ€, â€œvalidateâ€, â€œprocessâ€,
â€œnavigateâ€, â€œexploreâ€, â€œsignificant realizationâ€, â€œemotional containerâ€
	â€¢	Prefer:
â€œfor realâ€, â€œyeahâ€, â€œgot itâ€, â€œthatâ€™s toughâ€, â€œokay waitâ€, â€œhonestlyâ€¦â€, â€œhereâ€™s the thingâ€¦â€
	â€¢	Default: 1â€“3 sentences, max 1 question.
	â€¢	Humor: occasional only (light/dry), never corny, never memes.

3.2 Memory reference guidance (system prompt MUST include)

â€œYou have access to patterns from this session. Reference them ONLY through pattern language, never by citing past messages.â€
Examples:
âœ… â€œSleep keeps coming up.â€
âœ… â€œThis feels like that same loop again.â€
âŒ â€œYou mentioned this last time.â€
âŒ â€œEarlier you told meâ€¦â€

3.3 Dream door guidance (system prompt placement is explicit)

Insert immediately after Everyday Voice rules, before any pillar rules:

â€œIf the user mentions dreams (dream, dreamt, nightmare), respond conversationally (Dream Door experience). Do NOT suggest an activity. Keep focus on reflection, not actions.â€

3.4 Humor logging (measurement-friendly, no fancy enforcement)

Add DEV log field: humorAttempt: true/false per assistant reply.
Goal (manual QA): ~10â€“15% max across ~100 replies.

â¸»

4) BREATHING + DEEP MODE (STRUCTURE, NOT TONE)

Default strict mode:
	â€¢	<= 450 chars
	â€¢	1â€“3 sentences
	â€¢	max 1 question
	â€¢	no bullets

4.1 Deep mode trigger â€” clarified AND logic

Deep mode triggers IF:
	â€¢	(keyword present) AND (request-verb present)

Keywords (case-insensitive):
â€œplanâ€, â€œstepsâ€, â€œhow toâ€, â€œguideâ€, â€œexplainâ€, â€œbreakdownâ€

Request verbs:
â€œgive meâ€, â€œhelpâ€, â€œwalk me throughâ€, â€œcan youâ€, â€œshow meâ€, â€œteach meâ€

If both conditions true â†’ deep mode.

Deep mode:
	â€¢	<= 800 chars
	â€¢	max 2â€“3 bullets
	â€¢	STILL enforce everyday voice (no therapist tone)
	â€¢	Sanitizer still runs.

4.2 Crisis override formatting â€” clarified

Crisis mode:
	â€¢	<= 300 chars
	â€¢	line breaks allowed âœ…
	â€¢	up to 2â€“3 short bullets allowed âœ…
	â€¢	no long paragraphs âœ—

Implement: enforceBrevity(text, mode) where mode = strict | deep | crisis.

â¸»

5) INTUITION: NEXT BEST QUESTION PRIORITY STACK

Implement:
pickNextQuestion({ userText, signals, turnCount, lastUserText, lastAssistantText })

Return exactly ONE question (never â€œHow can I help?â€)

Priority order:
	1.	ACTION â€” stuck/help keywords (â€œstuckâ€, â€œwhat do I doâ€, â€œoverwhelmedâ€, â€œneed a planâ€, etc.)
	2.	CLARIFY â€” vagueness score high (short/meaningless replies)
	3.	DEEPEN â€” reflective/meaning seeking AND turnCount >= 6
	4.	CONFIRM â€” decision/commitment language detected
	5.	CLOSE â€” momentum drops

DEV log:
[TRACE BRAIN] Next Best Question chosen: { intent, reason, question }

â¸»

6) MEMORY LAYER (SUBTLE PATTERN REFERENCE â€” NOT â€œI REMEMBERâ€)

6.1 Extraction: expanded topic headers

Topic headers include:
work, relationship, sleep, money, health, TRACE, Nyla, church, school,
faith, purpose, family, career, anxiety, creativity, motivation

Fallback: keyword frequency extraction.

Loops keywords:
â€œstuckâ€, â€œagainâ€, â€œkeeps happeningâ€, â€œsameâ€, â€œloopâ€, â€œevery timeâ€, â€œalwaysâ€

Wins keywords:
positive sentiment + verbs (â€œdidâ€, â€œtriedâ€, â€œmanagedâ€, â€œfinallyâ€, â€œfinishedâ€, â€œshippedâ€, â€œcompletedâ€)

6.2 Promotion to activeLoops â€” tie-breaking clarified

Rule:
If same loop label appears 3+ times in last 10 USER turns â†’ qualifies.

If activeLoops.length < 3 â†’ promote.
If activeLoops.length == 3 and new loop qualifies â†’ replace oldest entry by timestamp.

ActiveLoops structure must include timestamps:
activeLoops: Array<{ label: string, timestamp: number }> (cap 3)

6.3 Dedup for wins/topics (polish)
	â€¢	recentWins should dedup by label (store once; update timestamp if repeated)
	â€¢	recentTopics should dedup similarly (update timestamp, do not add duplicates)

6.4 Memory decay + cleanup timing clarified (MUST run every request)

On EVERY /api/chat request, before responding:
	â€¢	filter recentTopics, activeLoops, recentWins removing items older than 6 hours
	â€¢	enforce caps with .slice(-N) patterns

If memory becomes empty because user returns after 6h+:
Optional re-entry line (no detail):
â€œFeels like itâ€™s been a minute â€” whatâ€™s the vibe today?â€

Do not say â€œI remember.â€

â¸»

7) PREMIUM MOMENTS (CLARIFIED FIRING POLICY)

7.1 Firing intent

Premium moments target emotional processing, not breakthroughs.
Do NOT trigger on â€œhappy winsâ€ alone.

7.2 Firing policy (answering the confusion explicitly)

âœ… Premium Moment can fire at most ONCE per 4-hour rolling window per user.
	â€¢	It is NOT â€œonce per session forever.â€
	â€¢	If user returns after 6+ hours â†’ new session; premium may fire again IF 4-hour window allows.
	â€¢	If user stays in one session for 4+ hours (rare), it may fire again, but still must pass turn cooldown.

Track:
	â€¢	lastPremiumMomentTime (timestamp)
	â€¢	lastPremiumMomentTurn (user-turn index)

7.3 Conditions (all must be true)
	â€¢	NOT crisis
	â€¢	NOT first chat
	â€¢	userMessageLength > 30
	â€¢	(reflectiveTone || meaningSeeking) AND (lowMood || rumination)
	â€¢	(turnCount - lastPremiumMomentTurn) >= 15
	â€¢	(now - lastPremiumMomentTime) >= 4 hours OR null

Format:
	â€¢	1 pattern sentence
	â€¢	1 next-step sentence
	â€¢	optional 1 question

Premium beats pause:
If both pause AND premium met â†’ premium fires, guided suppressed.

Premium does NOT reset guided-step cooldowns (independent systems).

DEV log:
[TRACE BRAIN] Premium Moment fired: { ... }

â¸»

8) GUIDED NEXT STEP PROMPTS (CONVERSATIONAL ONLY)

Guided steps are conversational re-engagement prompts, not activities.
If user says yes â†’ continue chat; do NOT output activity_suggestion.

8.1 ENFORCEMENT ORDER (NON-NEGOTIABLE)

ğŸ”´ MUST IMPLEMENT IN THIS EXACT ORDER:
	1.	If (turnCount - lastGuidedStepTurn) < 10 â†’ return early (NO guided step)
	2.	ONLY if cooldown passed â†’ check pause signals
	3.	If pause detected â†’ offer guided step

No exceptions.

State:
	â€¢	lastGuidedStepTurn

8.2 Pause detection rules (user-turn based)

Pause signals include:
	â€¢	userText < 15 chars after 4+ longer turns
	â€¢	user says: â€œokâ€, â€œthanksâ€, â€œidkâ€, â€œsureâ€, â€œlolâ€, â€œhmmâ€
	â€¢	conversation >= 12 user turns without action
	â€¢	user repeats same short response twice within last 3 user turns

8.3 Fuzzy match specifics (clarified)

For â€œshort response repeatsâ€:
	â€¢	normalize: lowercase
	â€¢	strip punctuation
	â€¢	split whitespace
	â€¢	extract first token root
	â€¢	treat â€œokâ€, â€œokayâ€, â€œok lolâ€, â€œok?â€ as same root â€œokâ€
Implementation rule:
if root token matches twice in last 3 user turns â†’ pause=true

Guided examples:
	â€¢	â€œWant a quick 60-second reset?â€
	â€¢	â€œWant me to pull the pattern Iâ€™m seeing?â€
	â€¢	â€œWant a tiny plan for today?â€

DEV log:
[TRACE BRAIN] Guided Step: { fired, reason }

â¸»

9) ANTI-REPETITION SYSTEM (SPECIFIED HASH + SIMILARITY)

State:
	â€¢	lastAssistantHash
	â€¢	lastAssistantText
	â€¢	recentPhrases rolling max 8

9.1 Hash algorithm specified

Use SHA-256:
crypto.createHash('sha256').update(first10WordsLowercased).digest('hex')

9.2 Similarity score specified (simple + deterministic)

Token overlap similarity:
	â€¢	tokenize both texts into unique tokens (lowercase, strip punctuation)
	â€¢	overlap = count of shared tokens
	â€¢	similarity = overlap / (uniqueTokensA.size + uniqueTokensB.size)  (0â€“1)

Threshold:
	â€¢	if similarity > 0.75 and hash differs â†’ log only (no regen)

9.3 Regen rule (one attempt + quality fallback)

Rules:
	1.	if hash == lastAssistantHash â†’ regenerate ONCE with:
â€œVary the opener. Keep the insight. Be shorter. Donâ€™t repeat.â€
	2.	If regen is worse (significantly shorter or loses helpful content):
	â€¢	â€œworseâ€ definition:
regenLength < 0.6 * originalLength OR missing the question/insight entirely
â†’ return ORIGINAL
	3.	Never loop more than once.

DEV log:
[TRACE BRAIN] Anti-repetition: { similarity, actionTaken, usedFallback }

â¸»

10) DREAM DOOR GATING (EXPLICIT)

If userText contains:
[â€œdreamâ€,â€œdreamtâ€,â€œhad a dreamâ€,â€œnightmareâ€,â€œdreamsâ€]
â†’ signals.doorway_hint=â€œdreamâ€

Then:
	â€¢	suppress activity_suggestion entirely (return null)
	â€¢	treat response as conversational reflection (Dream Door)
	â€¢	keep everyday voice, breathable output

â¸»

11) CLIENT STATE SCHEMA + CAPS + CLEANUP

client_state {
// repetition
lastAssistantHash: string
lastAssistantText: string
recentPhrases: string[] // cap 8

// memory (store timestamps)
recentTopics: Array<{ label: string, timestamp: number }> // cap 5, dedup
activeLoops: Array<{ label: string, timestamp: number }> // cap 3, replace oldest
recentWins: Array<{ label: string, timestamp: number }>  // cap 3, dedup

// premium
lastPremiumMomentTurn: number
lastPremiumMomentTime: number

// guided
lastGuidedStepTurn: number

// question
lastQuestionIntent: â€œclarifyâ€|â€œdeepenâ€|â€œactionâ€|â€œconfirmâ€|â€œcloseâ€|null

// session
sessionStartedAt: number
lastUserAt: number
sessionTurnCount: number
}

Cleanup must run every /api/chat call before responding.

â¸»

12) EXECUTION ORDER (STRICT PIPELINE)
	1.	session update + turnCount increment (user-only)
	2.	detect signals
	3.	memory extract + decay + caps + promotions
	4.	premium check
	5.	OpenAI call
	6.	sanitizeTraceVoice
	7.	enforceBrevity (strict/deep/crisis)
	8.	anti-repetition check + regen once + fallback allowed
	9.	dream gating for suggestions
	10.	return response

â¸»

DELIVERABLES

Return:
	1.	files modified + why
	2.	helpers added + call sites
	3.	proof hierarchy enforcement
	4.	proof: premium firing policy implemented exactly (4-hour window + 15-turn cooldown)
	5.	proof: guided-step cooldown enforcement order (early return before pause detection)
	6.	state cleanup + caps demonstrated in code

âœ… End. Implement carefully. No breaking changes.