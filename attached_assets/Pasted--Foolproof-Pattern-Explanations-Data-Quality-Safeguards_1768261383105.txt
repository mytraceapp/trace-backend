## Foolproof Pattern Explanations: Data Quality Safeguards

**CRITICAL:** Never explain patterns confidently when data is insufficient or unreliable.

### 1. Sample Size Gates (Backend)

**Before sending any pattern to chat context, validate:**

```javascript
// Backend validation before including in patternContext
function buildPatternContext(userId) {
  const patterns = getPatterns(userId);
  const context = {};
  
  // Peak Window: Require 7+ check-ins
  if (patterns.sampleSize >= 7 && patterns.peakWindow.label) {
    context.peakWindow = patterns.peakWindow.label;
  }
  
  // Stress Echoes: Require 5+ journal entries
  if (patterns.journalSampleSize >= 5 && patterns.stressEchoes?.label) {
    context.stressEchoes = patterns.stressEchoes.label;
  }
  
  // What Helps Most: Require 3+ uses
  if (patterns.mostHelpfulActivity?.count >= 3) {
    context.mostHelpfulActivity = patterns.mostHelpfulActivity.label;
    context.mostHelpfulCount = patterns.mostHelpfulActivity.count;
  }
  
  // Weekly Rhythm: Require 4+ active days
  if (patterns.activeDays >= 4 && patterns.weeklyRhythmPeak) {
    context.weeklyRhythmPeak = patterns.weeklyRhythmPeak;
  }
  
  // ONLY send patterns that pass thresholds
  return Object.keys(context).length > 0 ? context : null;
}
```

**Rule: If threshold not met, don't send the pattern at all.**

### 2. Confidence Scoring (Backend)

Add confidence levels to each pattern:

```javascript
{
  peakWindow: "10:30 AM – 1:30 PM",
  peakWindowConfidence: "high",  // high/medium/low based on sample size
  stressEchoes: "Work stress clusters around Tuesday afternoons",
  stressEchoesConfidence: "medium"
}
```

**AI instructions based on confidence:**
- **High (10+ samples):** "Your Peak Window is..."
- **Medium (7-9 samples):** "Your Peak Window seems to be..."
- **Low (4-6 samples):** "Early pattern suggests..."
- **None (<4 samples):** Don't mention at all

### 3. Hedging Language in System Prompt (Backend)

Add to your chat system prompt:

```
PATTERN DATA RELIABILITY RULES:

1. If confidence is "high": State patterns directly
   "Your Peak Window is 10:30 AM – 1:30 PM"

2. If confidence is "medium": Use gentle hedging
   "Your Peak Window seems to be around 10:30 AM – 1:30 PM"

3. If confidence is "low": Acknowledge limitations
   "Early pattern suggests you check in more around 10am, but I need more data to be sure"

4. If NO pattern data provided: Be honest
   "I don't have enough data yet to see patterns. Keep checking in and I'll start noticing rhythms."

5. NEVER invent patterns that aren't in the context
6. NEVER be more confident than the confidence score allows
```

### 4. Data Quality Checks (Backend)

Before sending pattern context, run sanity checks:

```javascript
function validatePatternQuality(pattern) {
  // Check for nonsensical data
  if (pattern.peakWindow) {
    const start = pattern.peakWindow.startHour;
    const end = pattern.peakWindow.endHour;
    
    // Invalid: window > 8 hours or < 1 hour
    if ((end - start) > 8 || (end - start) < 1) {
      console.error('[PATTERN QUALITY] Invalid peak window range');
      delete pattern.peakWindow;
    }
  }
  
  // Check for zero-count activities
  if (pattern.mostHelpfulCount === 0) {
    delete pattern.mostHelpfulActivity;
    delete pattern.mostHelpfulCount;
  }
  
  // Check for empty strings
  Object.keys(pattern).forEach(key => {
    if (pattern[key] === '' || pattern[key] === null) {
      delete pattern[key];
    }
  });
  
  return pattern;
}
```

### 5. Mobile: Don't Send Stale Cache

```typescript
// In chat.tsx when building pattern context
const PATTERN_CACHE_MAX_AGE = 5 * 60 * 1000; // 5 minutes

async function getPatternContextForChat() {
  const cached = await AsyncStorage.getItem('patterns_cache');
  if (!cached) return null;
  
  const { data, timestamp } = JSON.parse(cached);
  const age = Date.now() - timestamp;
  
  // Don't use stale data
  if (age > PATTERN_CACHE_MAX_AGE) {
    console.log('[CHAT] Pattern cache too old, skipping context');
    return null;
  }
  
  // Only send patterns that exist and meet thresholds
  return {
    peakWindow: data.peakWindowLabel || undefined,
    stressEchoes: data.stressEchoesLabel || undefined,
    mostHelpfulActivity: data.mostHelpfulActivityCount >= 3 
      ? data.mostHelpfulActivityLabel 
      : undefined,
    // ... etc
  };
}
```

### 6. Data Freshness & Timestamp Awareness

**Critical: Don't Mislead Users with Stale Data**

**Backend Requirements:**
- MUST include `lastCalculatedAt` timestamp (ISO 8601) in ALL pattern responses
- MUST include `lastCalculatedAt` in pattern context sent to chat
- Timestamp represents when backend last calculated this specific pattern

```typescript
// /api/patterns/insights response
{
  peakWindow: {
    label: "Midday Momentum",
    lastCalculatedAt: "2026-01-12T14:30:00.000Z",
    sampleSize: 12
  },
  stressEchoes: {
    patterns: [...],
    lastCalculatedAt: "2026-01-12T14:30:00.000Z",
    sampleSize: 8
  }
}
```

**Mobile Persistence Strategy:**
- NEVER remove current pattern data until new data is successfully fetched
- Show "last updated X hours ago" on patterns page
- Cache expires for DISPLAY after 24 hours (show refresh prompt, keep showing old data)
- Cache expires for CHAT CONTEXT after 5 minutes (fetch fresh before sending)

```typescript
// Mobile caching logic
const DISPLAY_CACHE_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours
const CHAT_CONTEXT_MAX_AGE = 5 * 60 * 1000; // 5 minutes

// Display: persist old data, show age
if (Date.now() - patternCache.lastCalculatedAt > DISPLAY_CACHE_MAX_AGE) {
  showRefreshPrompt(); // Don't hide old data
} else {
  showPatterns(patternCache.data); // Always show cached data
}

// Chat: fetch fresh if stale
if (Date.now() - patternCache.lastCalculatedAt > CHAT_CONTEXT_MAX_AGE) {
  await fetchFreshPatterns(); // Only then send to chat
}
```

**Chat AI Timestamp Communication:**
- AI MUST mention data age when explaining patterns older than 2 hours
- Use natural language: "Based on your patterns from this morning..." (2-6 hours old)
- Use explicit timestamps: "Looking at your patterns from yesterday..." (24+ hours old)
- NEVER imply real-time analysis when data is old

**System Prompt Rules for Backend:**
```
When explaining patterns from `patternContext`:
- If lastCalculatedAt < 2 hours ago: No timestamp mention needed
- If lastCalculatedAt 2-6 hours ago: "Based on your patterns from earlier today..."
- If lastCalculatedAt 6-24 hours ago: "Looking at your patterns from today..."
- If lastCalculatedAt > 24 hours ago: "Based on your patterns from [day]..." (e.g., "yesterday", "this week")
- NEVER say "right now" or "currently" when referring to pattern data
```

### 7. User Feedback Loop (Future Enhancement)

Add ability for users to correct patterns:

```
User: "My peak window isn't actually at 10am"
TRACE: "Got it. I'll keep learning. When do you tend to check in most?"

[Store correction, adjust confidence scores]
```

### 8. Crisis Mode Override (Backend)

```javascript
// In chat endpoint
if (userInCrisisMode) {
  // Don't send pattern context at all
  patternContext = null;
  
  // System prompt addition:
  "User is in crisis mode. Do not discuss patterns or analytics. 
   Focus only on immediate support and grounding."
}
```

### 9. A/B Fallback Responses

Train AI to give two-tier responses:

```
// If pattern context is provided:
"Your Peak Window is 10:30 AM – 1:30 PM. That's when your mind seems to need presence most."

// If pattern context is missing (insufficient data):
"I don't have enough check-ins yet to see when you tend to reach for TRACE most. 
 As you use TRACE more, I'll start noticing your rhythms."
```

---

## Implementation Checklist: Foolproof Patterns

**Backend:**
- [ ] Add `lastCalculatedAt` timestamp (ISO 8601) to ALL pattern responses
- [ ] Include `lastCalculatedAt` for EACH pattern type (peak, stress, relief, etc.)
- [ ] Accept `patternContext` with timestamps in `/api/chat` endpoint
- [ ] Add sample size gates (7+ for Peak, 5+ for Stress Echoes, 3+ for What Helps)
- [ ] Add confidence scoring (high/medium/low)
- [ ] Run data quality validation before sending
- [ ] Add hedging rules to system prompt based on confidence
- [ ] Add timestamp communication rules to system prompt (2hr/6hr/24hr thresholds)
- [ ] Override pattern context in crisis mode
- [ ] Log pattern explanations for monitoring

**Mobile:**
- [ ] Add `lastCalculatedAt` timestamp to pattern cache storage
- [ ] NEVER clear displayed patterns until new data arrives (persist old data)
- [ ] Show "last updated X hours ago" on patterns page
- [ ] Show refresh prompt after 24 hours (keep displaying old data)
- [ ] Check cache age before sending to chat (max 5 minutes old for context)
- [ ] Fetch fresh patterns if cache is stale for chat
- [ ] Send pattern context WITH timestamps to backend
- [ ] Only send patterns that meet minimum thresholds
- [ ] Detect pattern-related keywords to trigger context fetch
- [ ] Handle missing pattern context gracefully

**Monitoring:**
- [ ] Log when AI explains patterns (for quality review)
- [ ] Track user corrections/disagreements
- [ ] Alert if confidence scores consistently low
- [ ] Review pattern explanation accuracy monthly

---

## Example: Safe Pattern Explanation Flow

**Scenario: User has 3 check-ins (below threshold)**

```
User: "What's my peak window?"

Backend: 
- sampleSize = 3 (below threshold of 7)
- Don't include peakWindow in context
- patternContext = null

AI Response: 
"I don't have enough check-ins yet to see a pattern. 
 Keep using TRACE and I'll start noticing when you tend to reach for it most."
```

**Scenario: User has 8 check-ins (medium confidence, fresh data)**

```
User: "What's my peak window?"

Backend:
- sampleSize = 8 (meets threshold, medium confidence)
- peakWindow = "10:30 AM – 1:30 PM"
- lastCalculatedAt = 1 hour ago
- confidence = "medium"

AI Response:
"Your Peak Window seems to be around 10:30 AM – 1:30 PM. 
 That's when you've been checking in most this week."
```

**Scenario: User has 25 check-ins (high confidence, stale data)**

```
User: "What's my peak window?"

Backend:
- sampleSize = 25 (high confidence)
- peakWindow = "10:30 AM – 1:30 PM"
- lastCalculatedAt = 8 hours ago
- confidence = "high"

AI Response:
"Looking at your patterns from earlier today, your Peak Window is 10:30 AM – 1:30 PM. 
 That's consistently when your mind seems to need presence most."
```

**Scenario: User asks about patterns from yesterday**

```
User: "What were my stress echoes yesterday?"

Backend:
- lastCalculatedAt = 26 hours ago (yesterday's data)
- stressEchoes = ["9:00 AM", "3:00 PM"]

AI Response:
"Based on your patterns from yesterday, you tended to feel stressed around 9am and again at 3pm. 
 These times often appear together. Would you like me to refresh this with today's check-ins?"
```

---

## Migration Notes

Mobile is now a "thin client" - all intelligence lives in backend:
- ✅ Single source of truth for patterns
- ✅ No drift between mobile and backend calculations
- ✅ Easier to improve algorithms (backend-only changes)
- ✅ Consistent experience across platforms

**Status**: Backend API fully integrated ✅
