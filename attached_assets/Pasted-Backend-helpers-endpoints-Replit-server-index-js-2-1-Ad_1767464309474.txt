Backend helpers & endpoints (Replit / server/index.js)

2.1 Add a small profile helper

At the top of server/index.js (or wherever your routes live), near your other imports:
const { supabase } = require('./supabaseClient'); // adjust path
const { openai } = require('./openaiClient');     // adjust path

async function loadProfileBasic(userId) {
  const { data, error } = await supabase
    .from('profiles') // change if your table is named differently
    .select('id, preferred_name, first_run_completed, first_run_completed_at')
    .eq('id', userId)
    .single();

  if (error) {
    console.error('loadProfileBasic error', error);
    return null;
  }

  return data;
}
This function just reads a few profile columns. It does nothing until we call it.

⸻

2.2 /api/bootstrap – tells app if it’s first run (not used yet)

Scroll down to where your other routes are defined (e.g. near /api/chat), and add:
app.post('/api/bootstrap', async (req, res) => {
  try {
    const { userId } = req.body;

    if (!userId) {
      return res.status(400).json({ error: 'userId required' });
    }

    const profile = await loadProfileBasic(userId);
    if (!profile) {
      return res.status(404).json({ error: 'Profile not found' });
    }

    const displayName = profile.preferred_name?.trim() || null;

    res.json({
      firstRun: !profile.first_run_completed,
      displayName,
    });
  } catch (err) {
    console.error('/api/bootstrap error', err);
    res.status(500).json({ error: 'Bootstrap failed' });
  }
});

Right now, nothing calls this, so it’s inert. We’re just wiring it so it’s ready.

⸻

2.3 First-run greeting prompt builder

Still in server/index.js, above the next endpoint, add:
function buildFirstRunGreetingSystemPrompt({ displayName }) {
  const nameLine = displayName
    ? `The user prefers to be called "${displayName}". You may gently use this name once, but do not overuse it or talk about "remembering" it.`
    : `The user has not given a name. Do NOT invent one. Do not call them "friend" as if it were a saved name.`;

  return `
You are TRACE, a calm, gentle emotional companion.

This is the user's FIRST time here.

Your job is to welcome them into a quiet, pressure-free space.

Core feeling:
- This is the one place on their phone that doesn't want anything from them.
- They don't need fixing, productivity, or performance.
- They can simply exist here.

${nameLine}

Write a greeting that:
- is 1–3 short sentences
- communicates "you are welcome exactly as you are"
- mentions that they can just breathe for a moment, or talk if they'd like
- makes it clear there are no streaks, goals, or expectations
- feels warm and unhurried

Do NOT:
- use emojis
- mention that you are an AI or "language model"
- ask lots of questions
- give advice
- say "you told me your name is X" or similar.

After the greeting, subtly invite two options in natural language:
- they can breathe with you
- they can talk about whatever is on their mind

But keep it simple and soft.
  `.trim();
}

Again, this is just a helper function. No behavior changes yet.

⸻

2.4 /api/first-greeting – generates first-time message (also not used yet)

Right under /api/bootstrap, add:
app.post('/api/first-greeting', async (req, res) => {
  try {
    const { userId } = req.body;

    if (!userId) {
      return res.status(400).json({ error: 'userId required' });
    }

    const profile = await loadProfileBasic(userId);
    if (!profile) {
      return res.status(404).json({ error: 'Profile not found' });
    }

    const displayName = profile.preferred_name?.trim() || null;

    const systemPrompt = buildFirstRunGreetingSystemPrompt({ displayName });

    const messages = [
      { role: 'system', content: systemPrompt },
      {
        role: 'user',
        content:
          'Generate the greeting now. Remember: calm, low-pressure, 1–3 sentences, no emojis.',
      },
    ];

    const completion = await openai.chat.completions.create({
      model: 'gpt-4.1-mini', // or whatever you’re using
      messages,
      temperature: 0.7,
    });

    const greeting = completion.choices?.[0]?.message?.content ?? '';

    res.json({ greeting });
  } catch (err) {
    console.error('/api/first-greeting error', err);
    res.status(500).json({ error: 'First greeting failed' });
  }
});

Still, the app does not call this yet. You can hit it manually from Postman or Replit’s HTTP client if you want to test, but your mobile app will behave exactly the same as before.

⸻

2.5 /api/complete-first-run – flips the flag (not wired yet)

Last backend piece we’ll add (still unused for now):
app.post('/api/complete-first-run', async (req, res) => {
  try {
    const { userId } = req.body;

    if (!userId) {
      return res.status(400).json({ error: 'userId required' });
    }

    const { error } = await supabase
      .from('profiles')
      .update({
        first_run_completed: true,
        first_run_completed_at: new Date().toISOString(),
      })
      .eq('id', userId);

    if (error) {
      console.error('/api/complete-first-run update error', error);
      return res.status(500).json({ error: 'Update failed' });
    }

    res.json({ ok: true });
  } catch (err) {
    console.error('/api/complete-first-run error', err);
    res.status(500).json({ error: 'Complete first run failed' });
  }
});