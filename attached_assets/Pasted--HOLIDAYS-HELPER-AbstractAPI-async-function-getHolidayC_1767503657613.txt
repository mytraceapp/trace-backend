// ---- HOLIDAYS HELPER (AbstractAPI) ----

async function getHolidayContext({ countryCode, date = new Date() }) {
  const apiKey = process.env.ABSTRACT_HOLIDAYS_API_KEY;
  if (!apiKey) {
    console.warn('ABSTRACT_HOLIDAYS_API_KEY is missing');
    return null;
  }

  // Use ISO date parts
  const year = date.getUTCFullYear();
  const month = date.getUTCMonth() + 1; // 0-based
  const day = date.getUTCDate();

  const country = countryCode || 'US'; // fallback if you don't store country yet

  const url =
    `https://holidays.abstractapi.com/v1/` +
    `?api_key=${encodeURIComponent(apiKey)}` +
    `&country=${encodeURIComponent(country)}` +
    `&year=${year}&month=${month}&day=${day}`;

  let holidays;
  try {
    const res = await fetch(url);
    if (!res.ok) {
      console.error('AbstractAPI Holidays error:', res.status, await res.text());
      return null;
    }
    holidays = await res.json();
  } catch (err) {
    console.error('AbstractAPI Holidays fetch error:', err);
    return null;
  }

  if (!Array.isArray(holidays) || holidays.length === 0) {
    return null; // no holiday today
  }

  // Take the first relevant holiday
  const primary = holidays[0];

  const name = primary.name || primary.local_name || 'a holiday';
  const type = primary.type || ''; // depends on AbstractAPI’s response
  const isPublic = String(type).toLowerCase().includes('public');

  const summary =
    `HOLIDAY_CONTEXT: Today is ${name} in ${country}. ` +
    (isPublic
      ? `It's generally treated as a public holiday where many people may have different routines. `
      : `It's observed by some people but may not change everyone's schedule. `) +
    `Be gentle and aware that holidays can bring up mixed emotions—joy, grief, loneliness, or stress. ` +
    `Use this context only if the user mentions the date, the weekend, or the holiday itself. ` +
    `Do not mention that you used a holiday API or call this HOLIDAY_CONTEXT by name.`;

  return {
    summary,
    raw: holidays,
  };
}

app.post('/api/holidays', async (req, res) => {
  try {
    const { country, date } = req.body || {};
    const parsedDate = date ? new Date(date) : new Date();

    const ctx = await getHolidayContext({
      countryCode: country,
      date: parsedDate,
    });

    if (!ctx) {
      return res.json({ todayHasHoliday: false });
    }

    res.json({
      todayHasHoliday: true,
      summary: ctx.summary,
      raw: ctx.raw,
    });
  } catch (err) {
    console.error('/api/holidays error', err);
    res.status(500).json({ error: 'Internal server error' });
  }
});
Add HOLIDAY_CONTEXT into /api/chat

We’ll mirror weather/dog: a helper maybeAttachHolidayContext and then call it inside /api/chat.

4.1 Helper: maybeAttachHolidayContext

Add above /api/chat:
// ---- HOLIDAY IN CHAT HELPER ----

function isHolidayRelated(text) {
  if (!text) return false;
  const t = text.toLowerCase();

  return (
    t.includes('holiday') ||
    t.includes('christmas') ||
    t.includes('xmas') ||
    t.includes('new year') ||
    t.includes('thanksgiving') ||
    t.includes('easter') ||
    t.includes('hanukkah') ||
    t.includes('ramadan') ||
    t.includes('eid') ||
    t.includes('valentine') ||
    t.includes('my birthday') || // often tied to emotion around dates
    t.includes('today feels weird, it’s so quiet') // you can expand this later
  );
}

// Only attach holiday context when:
// - it's actually a holiday, and
// - the user seems to be talking about holidays / dates / that vibe.
async function maybeAttachHolidayContext({ messages, profile }) {
  const lastUser = [...messages].reverse().find((m) => m.role === 'user');
  if (!lastUser) {
    return { messages, holidaySummary: null };
  }

  if (!isHolidayRelated(lastUser.content)) {
    // If you want TRACE to be "holiday-aware" even without explicit mention,
    // you could relax this later. For now, keep it explicit.
    return { messages, holidaySummary: null };
  }

  const countryCode = profile?.country || 'US';

  const ctx = await getHolidayContext({ countryCode });
  if (!ctx) {
    return { messages, holidaySummary: null };
  }

  const holidaySystemMessage = {
    role: 'system',
    content: ctx.summary,
  };

  return {
    messages: [holidaySystemMessage, ...messages],
    holidaySummary: ctx.summary,
  };
}
Right now it only triggers if user’s recent message is holiday-ish. Later, if you want TRACE to proactively say “I know today is X,” we can loosen that.

⸻

5️⃣ Update /api/chat pipeline to include holidays

You already have/will have:
	•	maybeAttachWeatherContext
	•	maybeAttachDogContext
	•	long-term memory, etc.

We’ll chain holidays after dog (order doesn’t really matter, but keep it consistent).

Conceptual shape (adapt to your actual code):
app.post('/api/chat', async (req, res) => {
  try {
    const { userId, messages } = req.body || {};
    if (!userId || !messages) {
      return res.status(400).json({ error: 'userId and messages are required' });
    }

    const profile = await getProfileForUser(userId); // existing helper

    // 1) Weather (if they asked)
    const { messages: withWeather } = await maybeAttachWeatherContext({
      messages,
      profile,
    });

    // 2) Dog (if they talk about their dog)
    const { messages: withDog } = await maybeAttachDogContext({
      messages: withWeather,
      profile,
    });

    // 3) Holiday (if they talk about holidays / dates)
    const { messages: withHoliday } = await maybeAttachHolidayContext({
      messages: withDog,
      profile,
    });

    const systemPrompt = `
You are TRACE, a gentle, non-judgmental companion.

If HOLIDAY_CONTEXT is present in system messages:
- Use it to acknowledge the holiday softly if it feels relevant to what they're sharing.
- Remember holidays can bring joy, grief, loneliness, or stress. Respond with sensitivity.
- Do not mention HOLIDAY_CONTEXT or that you used an API.

If WEATHER_CONTEXT is present, you may use it only when they clearly ask about weather.

If DOG_CONTEXT is present, you may use it to relate kindly to their dog, without sounding like a vet or making medical claims.

If none of these contexts are present or relevant, respond normally.

Stay low-pressure, validating, and never transactional.
`.trim();

    const openaiResponse = await openai.chat.completions.create({
      model: 'gpt-4.1-mini', // or your current model
      messages: [
        { role: 'system', content: systemPrompt },
        ...withHoliday,
      ],
      temperature: 0.7,
    });

    const answer = openaiResponse.choices?.[0]?.message;
    if (!answer) {
      return res.status(500).json({ error: 'No response from model' });
    }

    res.json({ reply: answer });
  } catch (err) {
    console.error('/api/chat error', err);
    res.status(500).json({ error: 'Internal server error' });
  }
});